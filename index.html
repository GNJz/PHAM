// PHAM ê²Œì‹œë¬¼ ì‹œìŠ¤í…œ - ê¸°ì¡´ êµ¬ì¡° ì™„ì „ ë³´ì¡´
(function() {
    'use strict';
    
    let isSystemReady = false;
    
    // DOM ë¡œë“œ ì™„ë£Œ í›„ ì´ˆê¸°í™”
    function initialize() {
        if (isSystemReady) return;
        
        // ê¸°ì¡´ showSection í•¨ìˆ˜ í™•ì¥
        const originalShowSection = window.showSection;
        
        // ê¸°ì¡´ ë©”ë‰´ í´ë¦­ ì´ë²¤íŠ¸ì— í›„í‚¹
        const menuContent = document.getElementById('menuContent');
        if (menuContent) {
            menuContent.addEventListener('click', function(e) {
                const link = e.target.closest('[data-section]');
                if (!link) return;
                
                const sectionId = link.getAttribute('data-section');
                
                // memo ì„¹ì…˜ë“¤ë§Œ ì²˜ë¦¬
                if (sectionId && sectionId.startsWith('memo_')) {
                    setTimeout(() => loadPostsForSection(sectionId), 200);
                }
            });
        }
        
        isSystemReady = true;
        console.log('PHAM PostSystem ready');
    }
    
    async function loadPostsForSection(sectionId) {
        const section = document.getElementById(sectionId);
        if (!section) return;
        
        const memoNumber = sectionId.replace('memo_', '');
        const jsonFile = `data/memo${memoNumber}.json`;
        
        try {
            // ë¡œë”© ìƒíƒœ
            section.innerHTML = createLoadingHTML();
            
            const response = await fetch(`./${jsonFile}`);
            if (!response.ok) {
                throw new Error(`íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${jsonFile}`);
            }
            
            const posts = await response.json();
            renderPosts(posts, section, getSectionTitle(memoNumber));
            
        } catch (error) {
            console.log('ê²Œì‹œë¬¼ ë¡œë”© ì‹¤íŒ¨:', error.message);
            section.innerHTML = createEmptyStateHTML(getSectionTitle(memoNumber));
        }
    }
    
    function createLoadingHTML() {
        return `
            <div style="display: flex; justify-content: center; align-items: center; min-height: 300px;">
                <div style="text-align: center; color: #666;">
                    <div style="font-size: 1.5em; margin-bottom: 10px;">ğŸ“š</div>
                    <div>ê²Œì‹œë¬¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                </div>
            </div>
        `;
    }
    
    function createEmptyStateHTML(title) {
        return `
            <div style="max-width: 800px; margin: 0 auto; padding: 40px; text-align: center;">
                <h1 style="font-size: 2.5em; color: #333; margin-bottom: 30px;">${title}</h1>
                <div style="background: #f8f9fa; border-radius: 12px; padding: 40px; color: #666;">
                    <div style="font-size: 3em; margin-bottom: 20px;">âœï¸</div>
                    <p style="font-size: 1.2em; line-height: 1.6;">ì•„ì§ ê²Œì‹œë¬¼ì´ ì—†ìŠµë‹ˆë‹¤</p>
                    <p style="font-size: 0.9em; color: #999;">ê³§ í¥ë¯¸ë¡œìš´ ì½˜í…ì¸ ê°€ ì—…ë°ì´íŠ¸ë  ì˜ˆì •ì…ë‹ˆë‹¤</p>
                </div>
            </div>
        `;
    }
    
    function getSectionTitle(memoNumber) {
        const titles = {
            '1': 'ì´ê³¼ ëª¨ë“œ',
            '2': 'ë¬¸ê³¼ ëª¨ë“œ', 
            '3': 'ì˜ˆì²´ëŠ¥ ëª¨ë“œ',
            '4': 'ì¡ë‹´ ëª¨ë“œ'
        };
        return titles[memoNumber] || `ë©”ëª¨ ${memoNumber}`;
    }
    
    function renderPosts(posts, container, sectionTitle) {
        if (!posts || posts.length === 0) {
            container.innerHTML = createEmptyStateHTML(sectionTitle);
            return;
        }
        
        container.innerHTML = `
            <div style="max-width: 900px; margin: 0 auto; padding: 20px;">
                <header style="text-align: center; margin-bottom: 50px;">
                    <h1 style="font-size: 3em; color: #333; margin-bottom: 10px; font-weight: 300;">
                        ${sectionTitle}
                    </h1>
                    <div style="width: 60px; height: 2px; background: #007bff; margin: 0 auto;"></div>
                </header>
                <div id="posts-grid"></div>
            </div>
        `;
        
        const postsGrid = container.querySelector('#posts-grid');
        
        posts.forEach(post => {
            const postElement = createPostCard(post);
            postsGrid.appendChild(postElement);
        });
    }
    
    function createPostCard(post) {
        const article = document.createElement('article');
        article.className = 'post-card';
        article.style.cssText = `
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin: 25px 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid #f0f0f0;
            transition: all 0.4s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        `;
        
        // í˜¸ë²„ ì• ë‹ˆë©”ì´ì…˜
        article.addEventListener('mouseenter', () => {
            article.style.transform = 'translateY(-5px)';
            article.style.boxShadow = '0 12px 35px rgba(0,0,0,0.15)';
        });
        
        article.addEventListener('mouseleave', () => {
            article.style.transform = 'translateY(0)';
            article.style.boxShadow = '0 4px 20px rgba(0,0,0,0.08)';
        });
        
        // ì½˜í…ì¸  ìƒì„±
        let contentHTML = `
            <header style="margin-bottom: 20px;">
                <h2 style="font-size: 1.8em; color: #2c3e50; margin: 0; line-height: 1.3; font-weight: 600;">
                    ${post.title}
                </h2>
            </header>
        `;
        
        // ë³¸ë¬¸ ë‚´ìš©
        const formattedContent = formatPostContent(post.content, post.type, post.id);
        contentHTML += `
            <div style="line-height: 1.8; color: #444; font-size: 1.05em; white-space: pre-wrap; margin: 25px 0;">
                ${formattedContent}
            </div>
        `;
        
        // ì´ë¯¸ì§€ ì²˜ë¦¬
        if (post.images && post.images.length > 0) {
            contentHTML += '<div style="margin: 25px 0;">';
            post.images.forEach(imagePath => {
                contentHTML += `
                    <img src="./images/${imagePath}" 
                         alt="ê²Œì‹œë¬¼ ì´ë¯¸ì§€" 
                         style="max-width: 100%; height: auto; border-radius: 12px; 
                                margin: 10px 0; box-shadow: 0 4px 15px rgba(0,0,0,0.1);"
                         onerror="this.parentElement.removeChild(this)">
                `;
            });
            contentHTML += '</div>';
        }
        
        // ë©”íƒ€ ì •ë³´
        const typeLabel = post.type === 'long' ? 'ê¸´ ê¸€' : 'ì§§ì€ ê¸€';
        const typeColor = post.type === 'long' ? '#3498db' : '#e74c3c';
        
        contentHTML += `
            <footer style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee; 
                          display: flex; justify-content: space-between; align-items: center;">
                <time style="color: #7f8c8d; font-size: 0.9em;">
                    ğŸ“… ${post.date}
                </time>
                <span style="background: ${typeColor}; color: white; padding: 6px 14px; 
                           border-radius: 20px; font-size: 0.8em; font-weight: 500;">
                    ${typeLabel}
                </span>
            </footer>
        `;
        
        article.innerHTML = contentHTML;
        return article;
    }
    
    function formatPostContent(content, type, postId) {
        if (type === 'long' && content.length > 400) {
            const preview = content.substring(0, 400) + '...';
            const uniqueId = `expand_${postId}_${Date.now()}`;
            
            return `
                <div id="${uniqueId}_preview">${preview}</div>
                <div id="${uniqueId}_full" style="display: none;">${content}</div>
                <button onclick="toggleExpand('${uniqueId}')"
                        style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                               color: white; border: none; padding: 12px 24px; 
                               border-radius: 25px; cursor: pointer; margin-top: 20px;
                               font-size: 0.9em; font-weight: 500; transition: all 0.3s ease;"
                        onmouseover="this.style.transform='scale(1.05)'"
                        onmouseout="this.style.transform='scale(1)'">
                    ë” ì½ê¸° ğŸ“–
                </button>
            `;
        }
        return content;
    }
    
    // ì „ì—­ í•¨ìˆ˜ë¡œ ë” ì½ê¸° ê¸°ëŠ¥ ì œê³µ
    window.toggleExpand = function(uniqueId) {
        const preview = document.getElementById(uniqueId + '_preview');
        const full = document.getElementById(uniqueId + '_full');
        const button = event.target;
        
        if (preview && full && button) {
            preview.style.display = 'none';
            full.style.display = 'block';
            button.style.display = 'none';
        }
    };
    
    // ì´ˆê¸°í™” ì‹¤í–‰
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initialize);
    } else {
        initialize();
    }
    
})();