// PHAM 게시물 시스템 - 기존 구조 완전 보존
(function() {
    'use strict';
    
    let isSystemReady = false;
    
    // DOM 로드 완료 후 초기화
    function initialize() {
        if (isSystemReady) return;
        
        // 기존 showSection 함수 확장
        const originalShowSection = window.showSection;
        
        // 기존 메뉴 클릭 이벤트에 후킹
        const menuContent = document.getElementById('menuContent');
        if (menuContent) {
            menuContent.addEventListener('click', function(e) {
                const link = e.target.closest('[data-section]');
                if (!link) return;
                
                const sectionId = link.getAttribute('data-section');
                
                // memo 섹션들만 처리
                if (sectionId && sectionId.startsWith('memo_')) {
                    setTimeout(() => loadPostsForSection(sectionId), 200);
                }
            });
        }
        
        isSystemReady = true;
        console.log('PHAM PostSystem ready');
    }
    
    async function loadPostsForSection(sectionId) {
        const section = document.getElementById(sectionId);
        if (!section) return;
        
        const memoNumber = sectionId.replace('memo_', '');
        const jsonFile = `data/memo${memoNumber}.json`;
        
        try {
            // 로딩 상태
            section.innerHTML = createLoadingHTML();
            
            const response = await fetch(`./${jsonFile}`);
            if (!response.ok) {
                throw new Error(`파일을 찾을 수 없습니다: ${jsonFile}`);
            }
            
            const posts = await response.json();
            renderPosts(posts, section, getSectionTitle(memoNumber));
            
        } catch (error) {
            console.log('게시물 로딩 실패:', error.message);
            section.innerHTML = createEmptyStateHTML(getSectionTitle(memoNumber));
        }
    }
    
    function createLoadingHTML() {
        return `
            <div style="display: flex; justify-content: center; align-items: center; min-height: 300px;">
                <div style="text-align: center; color: #666;">
                    <div style="font-size: 1.5em; margin-bottom: 10px;">📚</div>
                    <div>게시물을 불러오는 중...</div>
                </div>
            </div>
        `;
    }
    
    function createEmptyStateHTML(title) {
        return `
            <div style="max-width: 800px; margin: 0 auto; padding: 40px; text-align: center;">
                <h1 style="font-size: 2.5em; color: #333; margin-bottom: 30px;">${title}</h1>
                <div style="background: #f8f9fa; border-radius: 12px; padding: 40px; color: #666;">
                    <div style="font-size: 3em; margin-bottom: 20px;">✍️</div>
                    <p style="font-size: 1.2em; line-height: 1.6;">아직 게시물이 없습니다</p>
                    <p style="font-size: 0.9em; color: #999;">곧 흥미로운 콘텐츠가 업데이트될 예정입니다</p>
                </div>
            </div>
        `;
    }
    
    function getSectionTitle(memoNumber) {
        const titles = {
            '1': '이과 모드',
            '2': '문과 모드', 
            '3': '예체능 모드',
            '4': '잡담 모드'
        };
        return titles[memoNumber] || `메모 ${memoNumber}`;
    }
    
    function renderPosts(posts, container, sectionTitle) {
        if (!posts || posts.length === 0) {
            container.innerHTML = createEmptyStateHTML(sectionTitle);
            return;
        }
        
        container.innerHTML = `
            <div style="max-width: 900px; margin: 0 auto; padding: 20px;">
                <header style="text-align: center; margin-bottom: 50px;">
                    <h1 style="font-size: 3em; color: #333; margin-bottom: 10px; font-weight: 300;">
                        ${sectionTitle}
                    </h1>
                    <div style="width: 60px; height: 2px; background: #007bff; margin: 0 auto;"></div>
                </header>
                <div id="posts-grid"></div>
            </div>
        `;
        
        const postsGrid = container.querySelector('#posts-grid');
        
        posts.forEach(post => {
            const postElement = createPostCard(post);
            postsGrid.appendChild(postElement);
        });
    }
    
    function createPostCard(post) {
        const article = document.createElement('article');
        article.className = 'post-card';
        article.style.cssText = `
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin: 25px 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid #f0f0f0;
            transition: all 0.4s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        `;
        
        // 호버 애니메이션
        article.addEventListener('mouseenter', () => {
            article.style.transform = 'translateY(-5px)';
            article.style.boxShadow = '0 12px 35px rgba(0,0,0,0.15)';
        });
        
        article.addEventListener('mouseleave', () => {
            article.style.transform = 'translateY(0)';
            article.style.boxShadow = '0 4px 20px rgba(0,0,0,0.08)';
        });
        
        // 콘텐츠 생성
        let contentHTML = `
            <header style="margin-bottom: 20px;">
                <h2 style="font-size: 1.8em; color: #2c3e50; margin: 0; line-height: 1.3; font-weight: 600;">
                    ${post.title}
                </h2>
            </header>
        `;
        
        // 본문 내용
        const formattedContent = formatPostContent(post.content, post.type, post.id);
        contentHTML += `
            <div style="line-height: 1.8; color: #444; font-size: 1.05em; white-space: pre-wrap; margin: 25px 0;">
                ${formattedContent}
            </div>
        `;
        
        // 이미지 처리
        if (post.images && post.images.length > 0) {
            contentHTML += '<div style="margin: 25px 0;">';
            post.images.forEach(imagePath => {
                contentHTML += `
                    <img src="./images/${imagePath}" 
                         alt="게시물 이미지" 
                         style="max-width: 100%; height: auto; border-radius: 12px; 
                                margin: 10px 0; box-shadow: 0 4px 15px rgba(0,0,0,0.1);"
                         onerror="this.parentElement.removeChild(this)">
                `;
            });
            contentHTML += '</div>';
        }
        
        // 메타 정보
        const typeLabel = post.type === 'long' ? '긴 글' : '짧은 글';
        const typeColor = post.type === 'long' ? '#3498db' : '#e74c3c';
        
        contentHTML += `
            <footer style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee; 
                          display: flex; justify-content: space-between; align-items: center;">
                <time style="color: #7f8c8d; font-size: 0.9em;">
                    📅 ${post.date}
                </time>
                <span style="background: ${typeColor}; color: white; padding: 6px 14px; 
                           border-radius: 20px; font-size: 0.8em; font-weight: 500;">
                    ${typeLabel}
                </span>
            </footer>
        `;
        
        article.innerHTML = contentHTML;
        return article;
    }
    
    function formatPostContent(content, type, postId) {
        if (type === 'long' && content.length > 400) {
            const preview = content.substring(0, 400) + '...';
            const uniqueId = `expand_${postId}_${Date.now()}`;
            
            return `
                <div id="${uniqueId}_preview">${preview}</div>
                <div id="${uniqueId}_full" style="display: none;">${content}</div>
                <button onclick="toggleExpand('${uniqueId}')"
                        style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                               color: white; border: none; padding: 12px 24px; 
                               border-radius: 25px; cursor: pointer; margin-top: 20px;
                               font-size: 0.9em; font-weight: 500; transition: all 0.3s ease;"
                        onmouseover="this.style.transform='scale(1.05)'"
                        onmouseout="this.style.transform='scale(1)'">
                    더 읽기 📖
                </button>
            `;
        }
        return content;
    }
    
    // 전역 함수로 더 읽기 기능 제공
    window.toggleExpand = function(uniqueId) {
        const preview = document.getElementById(uniqueId + '_preview');
        const full = document.getElementById(uniqueId + '_full');
        const button = event.target;
        
        if (preview && full && button) {
            preview.style.display = 'none';
            full.style.display = 'block';
            button.style.display = 'none';
        }
    };
    
    // 초기화 실행
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initialize);
    } else {
        initialize();
    }
    
})();